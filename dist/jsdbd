#!/usr/bin/env node
"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=require("path"),s=require("os"),n=require("child_process"),i=require("http"),r=e(i),o=e(require("events")),a=e(require("fs")),c=require("net"),l=1e3,u=6e4,d=36e5,h=24*d,f=function(e,t){t=t||{};var s=typeof e;if("string"===s&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return;var s=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*s;case"weeks":case"week":case"w":return 6048e5*s;case"days":case"day":case"d":return s*h;case"hours":case"hour":case"hrs":case"hr":case"h":return s*d;case"minutes":case"minute":case"mins":case"min":case"m":return s*u;case"seconds":case"second":case"secs":case"sec":case"s":return s*l;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return s;default:return}}(e);if("number"===s&&isFinite(e))return t.long?function(e){var t=Math.abs(e);if(t>=h)return p(e,t,h,"day");if(t>=d)return p(e,t,d,"hour");if(t>=u)return p(e,t,u,"minute");if(t>=l)return p(e,t,l,"second");return e+" ms"}(e):function(e){var t=Math.abs(e);if(t>=h)return Math.round(e/h)+"d";if(t>=d)return Math.round(e/d)+"h";if(t>=u)return Math.round(e/u)+"m";if(t>=l)return Math.round(e/l)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))};function p(e,t,s,n){var i=t>=1.5*s;return Math.round(e/s)+" "+n+(i?"s":"")}function m(e){return null==e?[]:Array.isArray(e)?e:[e]}function g(e,t,s,n){var i,r=e[t],o=~n.string.indexOf(t)?null==s||!0===s?"":String(s):"boolean"==typeof s?s:~n.boolean.indexOf(t)?"false"!==s&&("true"===s||(e._.push(0*(i=+s)==0?i:s),!!s)):0*(i=+s)==0?i:s;e[t]=null==r?o:Array.isArray(r)?r.concat(o):[r,o]}var w=function(e,t){t=t||{};var s,n,i,r,o,a={_:[]},c=0,l=0,u=0,d=(e=e||[]).length;const h=void 0!==t.alias,f=void 0!==t.unknown,p=void 0!==t.default;if(t.alias=t.alias||{},t.string=m(t.string),t.boolean=m(t.boolean),h)for(s in t.alias)for(n=t.alias[s]=m(t.alias[s]),c=0;c<n.length;c++)(t.alias[n[c]]=n.concat(s)).splice(c,1);if(t.boolean.forEach(e=>{t.boolean=t.boolean.concat(t.alias[e]=t.alias[e]||[])}),t.string.forEach(e=>{t.string=t.string.concat(t.alias[e]=t.alias[e]||[])}),p)for(s in t.default)t.alias[s]=t.alias[s]||[],(t[typeof t.default[s]]||[]).push(s);const w=f?Object.keys(t.alias):[];for(c=0;c<d;c++){if("--"===(i=e[c])){a._=a._.concat(e.slice(++c));break}for(l=0;l<i.length&&45===i.charCodeAt(l);l++);if(0===l)a._.push(i);else if("no-"===i.substring(l,l+3)){if(r=i.substring(l+3),f&&!~w.indexOf(r))return t.unknown(i);a[r]=!1}else{for(u=l+1;u<i.length&&61!==i.charCodeAt(u);u++);for(r=i.substring(l,u),o=i.substring(++u)||c+1===d||45===(""+e[c+1]).charCodeAt(0)||e[++c],n=2===l?[r]:r,u=0;u<n.length;u++){if(r=n[u],f&&!~w.indexOf(r))return t.unknown("-".repeat(l)+r);g(a,r,u+1<n.length||o,t)}}}if(p)for(s in t.default)void 0===a[s]&&(a[s]=t.default[s]);if(h)for(s in a)for(n=t.alias[s]||[];n.length>0;)a[n.shift()]=a[s];return a};const y="  ",v="__default__",b="\n";function _(e){if(!e.length)return"";let t=function(e){let t=0,s=0,n=0,i=e.length;if(i)for(;i--;)s=e[i].length,s>t&&(n=i,t=s);return e[n].length}(e.map(e=>e[0]))+4;return e.map(e=>e[0]+" ".repeat(t-e[0].length)+e[1]+(null==e[2]?"":`  (default ${e[2]})`))}function x(e){return e}function $(e,t,s){if(!t||!t.length)return"";let n=0,i="";for(i+=b+y+e;n<t.length;n++)i+="\n    "+s(t[n]);return i+b}var D=function(e,t,s,n){let i="",r=t[s],o=`$ ${e}`,a=t.__all__,c=e=>`${o} ${e}`.replace(/\s+/g," "),l=[["-h, --help","Displays this message"]];if(s===v&&l.unshift(["-v, --version","Displays current version"]),r.options=(r.options||[]).concat(a.options,l),r.options.length>0&&(r.usage+=" [options]"),i+=$("Description",r.describe,x),i+=$("Usage",[r.usage],c),n||s!==v)n||s===v||(i+=$("Aliases",r.alibi,c));else{let e=Object.keys(t).filter(e=>!/__/.test(e)),s=e.map(e=>[e,(t[e].describe||[""])[0]]);i+=$("Available Commands",_(s),x),i+="\n  For more info, run any command with the `--help` flag",e.slice(0,2).forEach(e=>{i+="\n    "+`${o} ${e} --help`}),i+=b}return i+=$("Options",_(r.options),x),i+=$("Examples",r.examples.map(c),x),i},A=function(e,t,s=1){let n=$("ERROR",[t],x);n+=b+y+`Run \`$ ${e} --help\` for more info.`+b,console.error(n),process.exit(s)},j=function(e){return(e||"").split(/^-{1,2}|,|\s+-{1,2}|\s+/).filter(Boolean)},O=function(e){return(e||"").replace(/([.?!])\s*(?=[A-Z])/g,"$1|").split("|")};const T="__default__";class I{constructor(e,t){let[s,...n]=e.split(/\s+/);t=t||n.length>0,this.bin=s,this.ver="0.0.0",this.default="",this.tree={},this.command("__all__"),this.command([T].concat(t?n:"<command>").join(" ")),this.single=t,this.curr=""}command(e,t,s={}){if(this.single)throw new Error('Disable "single" mode to add commands');let n=[],i=[],r=/(\[|<)/;if(e.split(/\s+/).forEach(e=>{(r.test(e.charAt(0))?i:n).push(e)}),n=n.join(" "),n in this.tree)throw new Error(`Command already exists: ${n}`);return n.includes("__")||i.unshift(n),i=i.join(" "),this.curr=n,s.default&&(this.default=n),this.tree[n]={usage:i,alibi:[],options:[],alias:{},default:{},examples:[]},s.alias&&this.alias(s.alias),t&&this.describe(t),this}describe(e){return this.tree[this.curr||T].describe=Array.isArray(e)?e:O(e),this}alias(...e){if(this.single)throw new Error('Cannot call `alias()` in "single" mode');if(!this.curr)throw new Error("Cannot call `alias()` before defining a command");return this.tree[this.curr].alibi=this.tree[this.curr].alibi.concat(...e),this}option(e,t,s){let n=this.tree[this.curr||"__all__"],[i,r]=j(e);if(r&&r.length>1&&([i,r]=[r,i]),e=`--${i}`,r&&r.length>0){e=`-${r}, ${e}`;let t=n.alias[r];n.alias[r]=(t||[]).concat(i)}let o=[e,t||""];return void 0!==s?(o.push(s),n.default[i]=s):r||(n.default[i]=void 0),n.options.push(o),this}action(e){return this.tree[this.curr||T].handler=e,this}example(e){return this.tree[this.curr||T].examples.push(e),this}version(e){return this.ver=e,this}parse(e,t={}){let s,n,i,r=2,o=w(e.slice(r),{alias:{h:"help",v:"version"}}),a=this.single,c=this.bin,l="";if(a)i=this.tree[T];else{let t,a=1,u=o._.length+1;for(;a<u;a++)if(s=o._.slice(0,a).join(" "),void 0!==this.tree[s])l=s,r=a+2;else for(t in this.tree)if(this.tree[t].alibi.includes(s)){l=t,r=a+2;break}if(i=this.tree[l],n=void 0===i,n)if(this.default)l=this.default,i=this.tree[l],e.unshift(l),r++;else if(s)return A(c,`Invalid command: ${s}`)}if(o.help)return this.help(!a&&!n&&l);if(o.version)return this._version();if(!a&&void 0===i)return A(c,"No command specified.");let u=this.tree.__all__;t.alias=Object.assign(u.alias,i.alias,t.alias),t.default=Object.assign(u.default,i.default,t.default);let d=w(e.slice(r),t);if(!d||"string"==typeof d)return A(c,d||"Parsed unknown option flag(s)!");let h=i.usage.split(/\s+/),f=h.filter(e=>"<"===e.charAt(0)),p=d._.splice(0,f.length);if(p.length<f.length)return l&&(c+=` ${l}`),A(c,"Insufficient arguments!");h.filter(e=>"["===e.charAt(0)).forEach(e=>{p.push(d._.shift())}),p.push(d);let m=i.handler;return t.lazy?{args:p,name:l,handler:m}:m.apply(null,p)}help(e){console.log(D(this.bin,this.tree,e||T,this.single))}_version(){console.log(`${this.bin}, ${this.ver}`)}}function E(e){return Array.isArray(e)?e.map(E):null===e||"object"!=typeof e?e:"$$date$$"in e?new Date(e.$$date$$):"$$undefined$$"in e?void 0:Object.entries(e).reduce((e,[t,s])=>({...e,[t]:E(s)}),{})}function k(e){return Array.isArray(e)?e.map(k):void 0===e?{$$undefined$$:!0}:e instanceof Date?{$$date$$:e.getTime()}:null===e||"object"!=typeof e?e:Object.entries(e).reduce((e,[t,s])=>({...e,[t]:k(s)}),{})}const N=Symbol("jsrpc");class S extends o{constructor(e){super();const{callTimeout:t,...s}=e,n=function(e){const t=new Map;let s=!1;return e.on("connection",e=>{t.set(e,0),e.once("close",()=>t.delete(e))}),e.on("request",(e,n)=>{const{socket:i}=e;t.set(i,t.get(i)+1),n.once("finish",()=>{const e=t.get(i)-1;t.set(i,e),s&&0===e&&i.end()})}),e.stop=n=>new Promise((i,r)=>{if(s)return i();s=!0;let o,a=!0;Array.from(t).map(([e,t])=>t||e.end()),e.close(e=>{if(e)return r(e);o&&clearTimeout(o),i(a)}),n&&(o=setTimeout(()=>{o=null,a=!1,Array.from(t.keys()).map(e=>e.end()),setImmediate(()=>Array.from(t.keys()).map(e=>e.destroy()))},n))}),e}(r.createServer(C.bind(this)));Object.defineProperty(this,N,{configurable:!0,value:{callTimeout:t,options:s,methods:{},server:n,started:!1}})}static create(e){return new S(e)}handle(e,t){return this[N].methods[e]=t,this}start(){return new Promise((e,t)=>{const{started:s,server:n,options:i}=this[N];if(s)return e(this);n.once("error",t),n.listen(i,s=>{if(s)return t(s);this[N].started=!0,this.emit("start"),e(this)})})}get started(){return this[N].started}get httpServer(){return this[N].server}async stop(){this[N].started&&(this[N].started=!1,await this[N].server.stop(5e3),this.emit("stop"))}}async function C(e,t){try{const{methods:i,callTimeout:r}=this[N],o=await function(e){return new Promise((t,s)=>{let n="";e.setEncoding("utf8"),e.on("error",s).on("data",e=>{n+=e}).on("end",()=>{try{t(JSON.parse(n))}catch(e){s(new F)}})})}(e),{id:a,jsonrpc:c,method:l,params:u}=o;if("2.0"!==c)throw new F(o);const d=i[l];if(!d)throw new M(o);if(!Array.isArray(u))throw new F(o);const h=E(u);this.emit("call",{method:l,params:h});let f=Promise.resolve(d.apply(this,h));r&&(s=f,n=r,f=new Promise((e,t)=>{const i=setTimeout(()=>t(new V),n);s.then(t=>{clearTimeout(i),e(t)},t)})),q(t,200,{jsonrpc:"2.0",result:k(await f),id:a})}catch(e){const{name:s,message:n}=e,i=k({name:s,message:n,...e});q(t,e.status||500,{jsonrpc:"2.0",error:i,id:void 0})}var s,n}function q(e,t,s){s=JSON.stringify(s),e.writeHead(t,{"content-type":"application/json;charset=utf-8","content-length":Buffer.byteLength(s)}),e.end(s)}class P extends Error{constructor(e,t){super(e),this.name=this.constructor.name,Error.captureStackTrace(this,this.constructor),Object.assign(this,t)}}class M extends P{constructor(e){super("Method not found",{status:404,body:e})}}class F extends P{constructor(e){super("Bad request",{status:400,body:e})}}class V extends P{constructor(e){super("Timed out",{status:504,body:e})}}const z={};class J{constructor(e){this.options=e}async call(e,...t){const s=JSON.stringify({jsonrpc:"2.0",method:e,params:k(t)}),n={...this.options,method:"POST",headers:{"Content-Type":"application/json;charset=utf-8","Content-Length":Buffer.byteLength(s),Connection:"keep-alive"}},r=await function(e,t){return new Promise((s,n)=>{const r=i.request(e,s);r.once("error",n),r.write(t),r.end()})}(n,s),o=await async function(e){e.setEncoding("utf8");let t="";for await(const s of e)t+=s;return JSON.parse(t)}(r);if(o.error){const e=E(o.error);throw new(J.error(e.name))(e)}return E(o.result)}static error(e){let t=z[e];return t||(t=function(e){function t(e){const{name:t,...s}=e;Error.call(this),Error.captureStackTrace(this,this.constructor),Object.assign(this,s)}return Object.defineProperties(t,{name:{value:e,configurable:!0}}),t.prototype=Object.create(Error.prototype,{name:{value:e,configurable:!0},constructor:{value:t,configurable:!0}}),t}(e),z[e]=t,t)}}var B;function R(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var L=R((B=Object.freeze({__proto__:null,default:class{constructor({width:e=1}={}){this.width=e,this.count=0,this.awaiters=[]}acquire(){return this.count<this.width?(this.count++,Promise.resolve()):new Promise(e=>this.awaiters.push(e))}release(){this.count&&(this.waiting?this.awaiters.shift()():this.count--)}get waiting(){return this.awaiters.length}async exec(e){try{return await this.acquire(),await Promise.resolve(e())}finally{this.release()}}}}))&&B.default||B),K=R(a);class U extends Error{constructor(e,t){super(t),this.name=e,Error.captureStackTrace(this,this.constructor)}}class G extends U{constructor(e,t){super("KeyViolation","Key violation error"),this.fieldName=t,this.record=e}}class H extends U{constructor(e){super("NotExists","Record does not exist"),this.record=e}}class Z extends U{constructor(e){super("NoIndex","No such index"),this.fieldName=e}}function Q(e,t){let s=0;for(t=t.split(".");e&&s<t.length;)e=e[t[s++]];return void 0===e||s<t.length?void 0:e}function W(e,t){const s=(n=X(e),Array.from(n).reduce((e,t)=>(e<<5)-e+t.charCodeAt(0)&4294967295,0));var n;for(let e=0;e<1e8;e++){const n=(s+e&2147483647).toString(36);if(!t.has(n))return n}throw new Error("Could not generate unique id")}function X(e){return JSON.stringify(e,(function(e,t){return this[e]instanceof Date?{$jsdb$date$:this[e].getTime()}:t}))}function Y(e){return JSON.parse(e,(function(e,t){return"$jsdb$date$"===e?new Date(t):"object"==typeof t&&"$jsdb$date$"in t?t.$jsdb$date$:t}))}class ee{static create(e){return new(e.unique?te:ee)(e)}constructor(e){this.options=e,this.data=new Map}find(e){const t=this.data.get(e);return t?Array.from(t):[]}findOne(e){const t=this.data.get(e);return t?t.values().next().value:void 0}addDoc(e){const t=Q(e,this.options.fieldName);Array.isArray(t)?t.forEach(t=>this.linkValueToDoc(t,e)):this.linkValueToDoc(t,e)}removeDoc(e){const t=Q(e,this.options.fieldName);Array.isArray(t)?t.forEach(t=>this.unlinkValueFromDoc(t,e)):this.unlinkValueFromDoc(t,e)}linkValueToDoc(e,t){if(null==e&&this.options.sparse)return;const s=this.data.get(e);s?s.add(t):this.data.set(e,new Set([t]))}unlinkValueFromDoc(e,t){const s=this.data.get(e);s&&(s.delete(t),s.size||this.data.delete(e))}}class te extends ee{findOne(e){return this.data.get(e)}find(e){return this.findOne(e)}linkValueToDoc(e,t){if(null!=e||!this.options.sparse){if(this.data.has(e))throw new G(t,this.options.fieldName);this.data.set(e,t)}}unlinkValueFromDoc(e,t){this.data.get(e)===t&&this.data.delete(e)}}const{readFile:se,appendFile:ne,open:ie,rename:re}=K.promises;class oe{constructor(e){this.options={serialize:X,deserialize:Y,special:{deleted:"$$deleted",addIndex:"$$addIndex",deleteIndex:"$$deleteIndex"},...e},this.empty()}empty(){this.indexes={_id:ee.create({fieldName:"_id",unique:!0})}}async ensureIndex(e){const{fieldName:t}=e,{addIndex:s}=this.options.special;this.hasIndex(t)||(this.addIndex(e),await this.append([{[s]:e}]))}async deleteIndex(e){const{deleteIndex:t}=this.options.special;if("_id"!==e){if(!this.hasIndex(e))throw new Z(e);this.removeIndex(e),await this.append([{[t]:{fieldName:e}}])}}addIndex(e){const{fieldName:t}=e,s=ee.create(e);this.allDocs().forEach(e=>s.addDoc(e)),this.indexes[t]=s}removeIndex(e){delete this.indexes[e]}hasIndex(e){return Boolean(this.indexes[e])}find(e,t){if(!this.hasIndex(e))throw new Z(e);return this.indexes[e].find(t)}findOne(e,t){if(!this.hasIndex(e))throw new Z(e);return this.indexes[e].findOne(t)}async upsert(e,t){let s,n;return Array.isArray(e)?(s=e.map(e=>this.addDoc(e,t)),n=s):(s=this.addDoc(e,t),n=[s]),await this.append(n),s}async delete(e){let t,s;const{deleted:n}=this.options.special;return Array.isArray(e)?(t=e.map(e=>this.removeDoc(e)),s=t):(t=this.removeDoc(e),s=[t]),s=s.map(e=>({[n]:e})),await this.append(s),t}addDoc(e,{mustExist:t=!1,mustNotExist:s=!1}={}){const{_id:n,...i}=e,r=this.findOne("_id",n);if(!r&&t)throw new H(e);if(r&&s)throw new G(e,"_id");var o;e={_id:n||W(e,this.indexes._id.data),...(o=i,Object.entries(o).reduce((e,[t,s])=>(void 0!==s&&(e[t]=s),e),{}))};const a=Object.values(this.indexes);try{return a.forEach(t=>{r&&t.removeDoc(r),t.addDoc(e)}),e}catch(t){throw a.forEach(t=>{t.removeDoc(e),r&&(t.removeDoc(r),t.addDoc(r))}),t}}removeDoc(e){const t=Object.values(this.indexes),s=this.findOne("_id",e._id);if(!s)throw new H(e);return t.forEach(e=>e.removeDoc(s)),s}allDocs(){return Array.from(this.indexes._id.data.values())}async hydrate(){const{filename:e,deserialize:t,special:{deleted:s,addIndex:n,deleteIndex:i}}=this.options,r=await se(e,{encoding:"utf8",flag:"a+"});this.empty();for(const e of r.split(/\n/).filter(Boolean)){const r=t(e);n in r?this.addIndex(r[n]):i in r?this.deleteIndex(r[i].fieldName):s in r?this.removeDoc(r[s]):this.addDoc(r)}}async rewrite({sorted:e=!1}={}){const{filename:t,serialize:s,special:{addIndex:n}}=this.options,i=t+"~",r=this.allDocs();e&&("string"!=typeof e&&"function"!=typeof e&&(e="_id"),r.sort(function(e){if("function"!=typeof e){const t=e;e=e=>Q(e,t)}return(t,s)=>{const n=e(t),i=e(s);return n<i?-1:n>i?1:0}}(e)));const o=Object.values(this.indexes).filter(e=>"_id"!==e.options.fieldName).map(e=>({[n]:e.options})).concat(r).map(e=>s(e)+"\n"),a=await ie(i,"w");await a.writeFile(o.join(""),"utf8"),await a.sync(),await a.close(),await re(i,t)}async append(e){const{filename:t,serialize:s}=this.options,n=e.map(e=>s(e)+"\n").join("");await ne(t,n,"utf8")}}class ae{constructor(e){if("string"==typeof e&&(e={filename:e}),!e)throw new TypeError("No options given");this.loaded=!1;const t=new L;Object.defineProperties(this,{_ds:{value:new oe(e),configurable:!0},_lock:{value:t,configurable:!0},_execute:{value:t.exec.bind(t),configurable:!0},_autoCompaction:{value:void 0,configurable:!0,writable:!0}}),this._lock.acquire(),e.autoload&&this.load(),e.autocompact&&this.setAutoCompaction(e.autocompact)}async load(){this.loaded||(this.loaded=!0,await this._ds.hydrate(),await this._ds.rewrite(),this._lock.release())}reload(){return this._execute(()=>this._ds.hydrate())}compact(e){return this._execute(()=>this._ds.rewrite(e))}ensureIndex(e){return this._execute(()=>this._ds.ensureIndex(e))}deleteIndex(e){return this._execute(()=>this._ds.deleteIndex(e))}insert(e){return this._execute(()=>this._ds.upsert(e,{mustNotExist:!0}))}update(e){return this._execute(()=>this._ds.upsert(e,{mustExist:!0}))}upsert(e){return this._execute(()=>this._ds.upsert(e))}delete(e){return this._execute(()=>this._ds.delete(e))}getAll(){return this._execute(async()=>this._ds.allDocs())}find(e,t){return this._execute(async()=>this._ds.find(e,t))}findOne(e,t){return this._execute(async()=>this._ds.findOne(e,t))}setAutoCompaction(e,t){this.stopAutoCompaction(),this._autoCompaction=setInterval(()=>this.compact(t),e)}stopAutoCompaction(){this._autoCompaction&&(clearInterval(this._autoCompaction),this._autoCompaction=void 0)}}Object.assign(ae,{KeyViolation:G,NotExists:H,NoIndex:Z});var ce=ae;function le(e){return new Promise((t,s)=>{const n=setTimeout(()=>s(new Error("timed out connecting to server")),500),i=c.createConnection(e,()=>{clearTimeout(n),setImmediate(()=>{i.destroy(),t(!0)})});i.once("error",()=>{clearTimeout(n),t(!1)})})}function ue(e){return(...t)=>Promise.resolve().then(()=>e(...t)).catch(e=>{console.error(e),process.exit(2)})}const de=new Set(["ensureIndex","deleteIndex","insert","update","upsert","delete","find","findOne","getAll","compact","reload"]);class he extends S{constructor({files:e=".",idleTime:s="30m",...n}){super(n),e=t.resolve(e),s=f(s+"");const i=Date.now();Object.assign(this,{files:e,idleTime:s,startTime:i}),this.openDatabases=new Map,this.handle("shutdown",fe.bind(this)).handle("status",pe.bind(this)).handle("dispatch",we.bind(this)).handle("housekeep",me.bind(this)).handle("clear",ge.bind(this)),setInterval(me.bind(this),s).unref()}}function fe(){setTimeout(()=>this.stop(5e3))}function pe(){const e=Date.now();return{uptime:e-this.startTime,idleTime:this.idleTime,files:this.files,databases:Array.from(this.openDatabases.entries()).map(([t,{db:s,lastTouch:n}])=>({name:t,uptime:e-n}))}}function me(){const e=Date.now();Array.from(this.openDatabases.entries()).forEach(([t,{lastTouch:s}])=>{e-s>this.idleTime&&this.openDatabases.delete(t)})}function ge(){this.openDatabases.clear()}async function we(e,s,...n){if(!de.has(s))throw new Error(`Unknown method: ${s}`);e=t.resolve(this.files,e);const i=Date.now();let r;const o=this.openDatabases.get(e);return o?(o.lastTouch=i,r=o.db):(r=new ce(e),this.openDatabases.set(e,{db:r,lastTouch:i})),r.loaded||await r.load(),r[s](...n)}const ye=new I("jsdbd",ve);var ve;const be=t.resolve(s.homedir(),".databases");async function _e({port:e},t,...s){return await le(e)||(console.log(`No server active on port ${e}`),process.exit(1)),new J({port:e}).call(t,...s)}ye.version("2.1.0").option("--port, -p","The port to use",39720),ye.command("status","shows the status of the jsdbd daemon",{default:!0}).action(ue((async function({port:e}){const t=await _e({port:e},"status");console.log(`jsdb server running on port ${e}\n`),console.log(`Uptime: ${f(t.uptime,{long:!0})}`),console.log(`Housekeep every ${f(t.idleTime)}`),console.log(`Database files: ${t.files}\n`);const{databases:s}=t;if(!s.length)return void console.log("No databases open");console.log("Databases open:");for(const{name:e,uptime:t}of s)console.log(`  ${e} (${f(t,{long:!0})})`)}))),ye.command("start","starts the server").option("-f, --files","where files area stored",be).option("-s, --silent","be quiet").option("--idle-time","cleaning interval","30m").action(ue((async function(e){let{files:s,idleTime:i,port:r,silent:o}=e;if(s=t.resolve(s),await le(r))return void(o||console.log(`Server already active on port ${r}`));const a=process.execPath,c=[...process.execArgv,process.argv[1],"__server","--port",r,"--files",s,"--idle-time",i];n.spawn(a,c,{stdio:"ignore",detached:!0}).unref(),o||console.log(`Serving databases in ${s} on port ${r}`)}))),ye.command("clear","closes all databases").action(ue((async function({port:e}){await _e({port:e},"clear"),console.log(`All databases cleared on port ${e}`)}))),ye.command("stop","stops the server").action(ue((async function({port:e}){await _e({port:e},"shutdown"),console.log(`Server on port ${e} shut down`)}))),ye.command("__server","runs the server (internal use)").action(ue((function(e){const{idleTime:t,files:s,port:n}=e,i=new he({idleTime:t,files:s,port:n}),r=()=>i.stop();return process.on("SIGINT",r).on("SIGTERM",r),i.start()}))),ye.parse(process.argv,{alias:{idleTime:"idle-time"}});
